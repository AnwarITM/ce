<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WSID Planner • Single File (Sorted & Colored)</title>

  <!-- SheetJS (Excel parser) via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <!-- ===================== INLINE CSS ===================== -->
  <link rel="stylesheet" href="design-tokens.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --w-handle: 40px;
      --w-wsid: 110px;
      --w-lokasi: 300px;
      --w-plan: 110px;
      --w-status: 120px;
      --w-note: 220px;
    }

    body {
      margin: 0;
      /* Background handled by styles.css (image) */
      color: var(--text-color);
      font-family: var(--font-family);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--primary-hover);
    }

    .hint {
      color: #64748b;
      font-size: 12px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: var(--glass-border);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.12);
      transform: translateY(-2px);
    }

    .card h3 {
      margin: 0 0 12px 0;
      font-size: 15px;
      color: #4f46e5;
      font-weight: 600;
    }

    .btn {
      appearance: none;
      border: var(--glass-border);
      background: var(--gradient-primary);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-family: var(--font-family);
    }

    .btn.primary {
      background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(139, 92, 246, 1));
    }

    .btn.ghost {
      background: rgba(255, 255, 255, 0.6);
      color: #4f46e5;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .input,
    select,
    textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: #1e293b;
      padding: 10px 12px;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.5);
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
    }

    .tab {
      padding: 10px 16px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      cursor: pointer;
      color: #64748b;
      transition: all 0.3s ease;
    }

    .tab.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
      color: #4f46e5;
      border-color: rgba(99, 102, 241, 0.3);
    }

    /* Table */
    .table-wrap {
      overflow: auto;
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    table {
      width: max-content;
      min-width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead th {
      position: sticky;
      top: 0;
      background: rgba(99, 102, 241, 0.08);
      z-index: 2;
      color: #4f46e5;
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 700;
    }

    .cell-left {
      text-align: left;
    }

    .compact {
      font-size: 12px;
      letter-spacing: 0.02em;
    }

    /* Drag visuals */
    .handle {
      cursor: grab;
      opacity: 0.8;
    }

    tr.dragging {
      outline: 2px dashed #6366f1;
      background: rgba(99, 102, 241, 0.1);
    }

    .placeholder {
      height: 2px;
      background: #6366f1;
    }

    /* Segmented control */
    .seg {
      display: inline-flex;
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.4);
    }

    .seg button {
      border: 0;
      background: transparent;
      color: #64748b;
      padding: 8px 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .seg button.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
      color: #4f46e5;
    }

    /* Colored status select */
    .status-select {
      width: 100%;
    }

    .status-outstanding {
      background: rgba(255, 107, 107, 0.15);
      color: #dc2626;
      border-color: rgba(255, 107, 107, 0.35);
    }

    .status-done {
      background: rgba(46, 204, 113, 0.15);
      color: #16a34a;
      border-color: rgba(46, 204, 113, 0.35);
    }

    /* Reset override from global styles.css */
    #table th,
    #table td {
      width: auto;
      /* let colgroup decide */
    }

    th.cell-left {
      text-align: left;
    }

    .status-select {
      text-align: center;
      text-align-last: center;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
      :root {
        --w-handle: 30px;
        --w-wsid: 60px;
        --w-lokasi: 110px;
        --w-plan: 70px;
        --w-status: 85px;
        --w-note: 120px;
      }

      .page {
        padding: 12px;
        gap: 12px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .title {
        font-size: 20px;
      }

      .hint {
        font-size: 11px;
      }

      .row {
        gap: 8px;
      }

      .card {
        padding: 14px;
        border-radius: 12px;
      }

      .card h3 {
        font-size: 14px;
        margin-bottom: 10px;
      }

      .btn {
        padding: 8px 12px;
        font-size: 13px;
        border-radius: 10px;
      }

      .input,
      select,
      textarea {
        padding: 8px 10px;
        font-size: 13px;
        border-radius: 10px;
      }

      .tabs {
        gap: 6px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab {
        padding: 8px 12px;
        font-size: 12px;
        white-space: nowrap;
      }

      .seg button {
        padding: 6px 10px;
        font-size: 12px;
      }

      .table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        font-size: 12px;
        width: 100%;
        /* Fit to screen */
      }

      th,
      td {
        padding: 8px 4px;
        font-size: 11px;
        white-space: normal;
        /* Allow wrap on mobile */
      }

      th {
        font-size: 10px;
      }

      .status-select {
        font-size: 11px;
        padding: 6px 8px;
      }

      textarea {
        min-height: 60px;
        font-size: 12px;
      }
    }

    @media (max-width: 560px) {
      .page {
        padding: 8px;
        gap: 10px;
      }

      .title {
        font-size: 18px;
      }

      .hint {
        font-size: 10px;
      }

      .card {
        padding: 12px;
      }

      .card h3 {
        font-size: 13px;
      }

      .btn {
        padding: 7px 10px;
        font-size: 12px;
      }

      .input,
      select,
      textarea {
        padding: 7px 9px;
        font-size: 12px;
      }

      .tab {
        padding: 7px 10px;
        font-size: 11px;
      }

      .seg button {
        padding: 5px 8px;
        font-size: 11px;
      }

      th,
      td {
        padding: 6px 4px;
        font-size: 10px;
      }

      th {
        font-size: 9px;
      }

      .status-select {
        font-size: 10px;
        padding: 5px 6px;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- ===================== HEADER ===================== -->
    <div class="header">
      <div>
        <div class="title">WSID Planner (Sorted & Colored)</div>
        <div class="hint">Import Excel → Mapping (WSID/Lokasi/Plan) → Proses. Terfilter WSID Saya, urut Plan
          termuda→tertua.</div>
      </div>
      <div class="row">
        <button class="btn" id="btnExportConfig">Export Config</button>
        <label class="btn ghost" for="importConfig">Import Config</label>
        <input type="file" id="importConfig" accept="application/json" hidden>
      </div>
    </div>

    <!-- ===================== WSID PEGANGANKU ===================== -->
    <div class="card">
      <h3>WSID Peganganku</h3>
      <div class="row">
        <textarea id="taWsids" class="input" placeholder="Tulis WSID milikmu. Pisahkan koma atau baris."></textarea>
      </div>
      <div class="row" style="align-items:center;justify-content:space-between;margin-top:8px">
        <div class="hint" id="wsidCount">Belum ada WSID tersimpan</div>
        <div class="row">
          <button class="btn" id="btnSaveWsids">Simpan WSID</button>
        </div>
      </div>
    </div>

    <!-- ===================== IMPORT EXCEL + MAPPING ===================== -->
    <div class="card">
      <h3>Import Excel & Mapping Kolom</h3>
      <div class="row">
        <input type="file" id="excelFile" accept=".xlsx" class="input">
        <button class="btn" id="btnReadExcel">Baca File</button>
      </div>
      <div class="hint" id="fileInfo" style="margin-top:6px">Belum ada file.</div>

      <!-- Mapping dropdowns -->
      <div class="row" style="margin-top:12px">
        <div style="min-width:180px">
          <div class="hint">Kolom WSID</div>
          <select id="mapWSID"></select>
        </div>
        <div style="min-width:220px">
          <div class="hint">Kolom Lokasi</div>
          <select id="mapLokasi"></select>
        </div>
        <div style="min-width:200px">
          <div class="hint">Kolom Plan (Tanggal)</div>
          <select id="mapPlan"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSaveMapping">Simpan Mapping</button>
        <button class="btn primary" id="btnProcess">Proses Data</button>
      </div>
      <div class="hint" style="margin-top:6px">Status diatur user per baris (default Outstanding). Kedua tab hanya
        menampilkan WSID yang kamu simpan.</div>
    </div>

    <!-- ===================== TABS & FILTER ===================== -->
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="tabs">
        <div class="tab active" data-tab="excel">Data Excel (WSID Saya)</div>
        <div class="tab" data-tab="mine">WSID Saya + Catatan</div>
      </div>
      <div class="row" style="align-items:center">
        <div class="seg" id="segFilter">
          <button data-v="all" class="active">All</button>
          <button data-v="done">Done</button>
          <button data-v="outstanding">Outstanding</button>
        </div>
        <button class="btn" id="btnExportCSV" style="margin-left:8px">Export CSV</button>
      </div>
    </div>

    <!-- ===================== METRICS ===================== -->
    <div class="row">
      <div class="card" style="flex:1">
        <div class="hint">Total</div>
        <div id="mTotal" style="font-weight:700;font-size:18px">0</div>
      </div>
      <div class="card" style="flex:1">
        <div class="hint">Done</div>
        <div id="mDone" style="font-weight:700;font-size:18px">0</div>
      </div>
      <div class="card" style="flex:1">
        <div class="hint">Outstanding</div>
        <div id="mOut" style="font-weight:700;font-size:18px">0</div>
      </div>
    </div>

    <!-- ===================== TABLE ===================== -->
    <div class="table-wrap">
      <table id="table">
        <!-- colgroup di-render via JS agar header & data 100% sejajar -->
        <colgroup id="colgroup"></colgroup>
        <thead>
          <tr id="thead"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="hint">Tanggal Excel (angka serial) otomatis diformat seperti <b>07 Nov 2025</b> dan dipakai untuk
      pengurutan (termuda→tertua).</div>
  </div>

  <!-- ===================== INLINE JS ===================== -->
  <script>
    // ----------------------- State & Storage -----------------------
    const LS_KEYS = {
      userWsids: 'wsid.userWsids',
      columnMap: 'wsid.columnMapping',     // { wsid, lokasi, plan }
      lastDataset: 'wsid.lastDataset',       // normalized rows
      wsidOrder: 'wsid.wsidOrder',         // order for "mine" tab
      notesByKey: 'wsid.notesByKey',        // { "WSID|Plan": "note" }
      statusByKey: 'wsid.statusByKey',       // { "WSID|Plan": "done|outstanding" }
    };
    const state = {
      rawRows: [],
      dataset: [],             // { WSID,Lokasi,Plan,Status, PlanAt:number|null }
      filter: 'all',           // all|done|outstanding
      activeTab: 'excel',      // excel|mine
      mapping: loadJSON(LS_KEYS.columnMap) || { wsid: '', lokasi: '', plan: '' },
      userWsids: loadJSON(LS_KEYS.userWsids) || [],
      wsidOrder: loadJSON(LS_KEYS.wsidOrder) || [],
      notesByKey: loadJSON(LS_KEYS.notesByKey) || {},
      statusByKey: loadJSON(LS_KEYS.statusByKey) || {},
      _A: null,
      _headerRowIdx: -1,
    };
    function saveJSON(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
    function loadJSON(k) { try { return JSON.parse(localStorage.getItem(k) || 'null'); } catch (e) { return null; } }
    const $ = s => document.querySelector(s);

    // ----------------------- Helpers -----------------------
    const CAND_WS = ['wsid', 'id mesin', 'id_ws', 'id atm', 'no wsid', 'data mesin'];
    const CAND_LOC = ['lokasi', 'alamat', 'location', 'site', 'address'];
    const CAND_PLAN = ['plan', 'bulan', 'month', 'jadwal', 'periode', 'period', 'tanggal', 'date'];

    function guessColumn(cols, cands) {
      const lower = cols.map(c => String(c).toLowerCase());
      for (const k of cands) { const i = lower.findIndex(x => x.includes(k)); if (i >= 0) return cols[i]; }
      return cols[0] || '';
    }
    function textToWsids(text) {
      return (text || '').split(/\n|,|;|\s+/g).map(s => s.trim()).filter(Boolean);
    }
    function keyOf(row) { return `${row.WSID}|${row.Plan}`; }

    // Excel serial date -> Date (UTC)
    function excelSerialToDate(val) {
      if (typeof val !== 'number' || !isFinite(val)) return null;
      const d = XLSX.SSF.parse_date_code(val);
      if (!d || !d.y || !d.m || !d.d) return null;
      return new Date(Date.UTC(d.y, d.m - 1, d.d));
    }
    // Format date to "dd MMM yyyy"
    function fmtDate(d, locale = 'id-ID') {
      return d.toLocaleDateString(locale, { day: '2-digit', month: 'short', year: 'numeric' });
    }
    // Try parse non-serial plan (common patterns)
    function tryParsePlanText(val) {
      if (val == null) return null;
      if (val instanceof Date) return val;
      const s = String(val).trim();
      if (!s) return null;

      // dd/mm/yyyy or dd-mm-yyyy
      let m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})$/);
      if (m) {
        const dd = +m[1], mm = +m[2], yy = +m[3]; const fullY = yy < 100 ? (2000 + yy) : yy;
        const d = new Date(Date.UTC(fullY, mm - 1, dd)); if (!isNaN(d)) return d;
      }
      // mm/yyyy or m/yyyy
      m = s.match(/^(\d{1,2})[\/.-](\d{2,4})$/);
      if (m) {
        const mm = +m[1], yy = +m[2]; const fullY = yy < 100 ? (2000 + yy) : yy;
        const d = new Date(Date.UTC(fullY, mm - 1, 1)); if (!isNaN(d)) return d;
      }
      // "Nov 2025" / "November 2025" (id or en short acceptable if browser supports)
      const tryD = Date.parse(s);
      if (!isNaN(tryD)) return new Date(tryD);

      return null;
    }

    // ----------------------- UI Refs -----------------------
    const taWsids = $('#taWsids'), wsidCount = $('#wsidCount'), btnSaveWsids = $('#btnSaveWsids');
    const excelFile = $('#excelFile'), btnReadExcel = $('#btnReadExcel'), fileInfo = $('#fileInfo');
    const mapWSID = $('#mapWSID'), mapLokasi = $('#mapLokasi'), mapPlan = $('#mapPlan');
    const btnSaveMapping = $('#btnSaveMapping'), btnProcess = $('#btnProcess');
    const tabs = [...document.querySelectorAll('.tab')];
    const seg = $('#segFilter'); const btnExportCSV = $('#btnExportCSV');
    const mTotal = $('#mTotal'), mDone = $('#mDone'), mOut = $('#mOut');
    const colgroup = $('#colgroup'), thead = $('#thead'), tbody = $('#tbody');
    const btnExportConfig = $('#btnExportConfig'), importConfig = $('#importConfig');

    // ----------------------- Init -----------------------
    taWsids.value = (state.userWsids || []).join('\n'); updateWsidsCount();

    seg.querySelectorAll('button').forEach(b => {
      b.addEventListener('click', () => {
        seg.querySelectorAll('button').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        state.filter = b.dataset.v; renderTable();
      });
    });
    tabs.forEach(t => {
      t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        state.activeTab = t.dataset.tab; // 'excel' | 'mine'
        renderHead(); renderTable();
      });
    });

    btnSaveWsids.addEventListener('click', () => {
      const wsids = textToWsids(taWsids.value);
      state.userWsids = [...new Set(wsids)];
      saveJSON(LS_KEYS.userWsids, state.userWsids);
      // reconcile order
      state.wsidOrder = state.wsidOrder.filter(w => state.userWsids.includes(w));
      for (const w of state.userWsids) if (!state.wsidOrder.includes(w)) state.wsidOrder.push(w);
      saveJSON(LS_KEYS.wsidOrder, state.wsidOrder);
      updateWsidsCount(); renderTable();
    });
    function updateWsidsCount() { const n = state.userWsids.length; wsidCount.innerHTML = n ? `Tersimpan <b>${n}</b> WSID` : 'Belum ada WSID tersimpan'; }

    // ----------------------- BACA EXCEL (ROBUST HEADER) -----------------------
    btnReadExcel.addEventListener('click', async () => {
      const f = excelFile.files?.[0];
      if (!f) { alert('Pilih file .xlsx dahulu'); return; }
      fileInfo.textContent = `Membaca: ${f.name} ...`;

      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      // Matrix mode untuk deteksi header manual
      const A = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', blankrows: false });

      // Cari baris header (mengandung WSID/Lokasi/Plan)
      const hasAny = (row, arr) => row.some(c => arr.some(k => String(c).toLowerCase().includes(k)));
      let headerRowIdx = -1;
      for (let i = 0; i < Math.min(A.length, 30); i++) {
        const row = A[i].map(x => String(x || ''));
        const score =
          (hasAny(row, CAND_WS) ? 1 : 0) +
          (hasAny(row, CAND_LOC) ? 1 : 0) +
          (hasAny(row, CAND_PLAN) ? 1 : 0);
        if (score >= 1 || row.join('').toLowerCase().includes('wsid')) { headerRowIdx = i; break; }
      }
      if (headerRowIdx < 0) {
        alert('Header tidak ditemukan (WSID/Lokasi/Plan). Rapikan header Excel atau pilih sheet yang benar.');
        fileInfo.textContent = 'Header tidak ditemukan';
        return;
      }

      // Simpan matrix & index header untuk konversi tanggal saat proses
      state._A = A; state._headerRowIdx = headerRowIdx;

      // Bentuk header unik
      const rawHeader = A[headerRowIdx].map(s => String(s || '').trim());
      const header = []; const seen = {};
      for (let name of rawHeader) { if (!name) name = 'col'; if (seen[name] == null) { seen[name] = 0; header.push(name); } else { seen[name]++; header.push(`${name}_${seen[name]}`); } }

      // Data rows di bawah header -> objek (raw)
      const dataRows = [];
      for (let r = headerRowIdx + 1; r < A.length; r++) {
        const row = A[r] || [];
        if (!row.some(v => String(v || '').trim().length)) continue;
        const obj = {};
        for (let c = 0; c < header.length; c++) obj[header[c]] = row[c] != null ? row[c] : '';
        dataRows.push(obj);
      }

      state.rawRows = dataRows;
      fileInfo.textContent = `OK: ${f.name} | sheet: ${sheetName} | baris: ${dataRows.length} | header di baris ${headerRowIdx + 1}`;

      // Isi dropdown mapping pakai header hasil deteksi
      fillSelect(mapWSID, header, state.mapping.wsid || guessColumn(header, CAND_WS));
      fillSelect(mapLokasi, header, state.mapping.lokasi || guessColumn(header, CAND_LOC));
      fillSelect(mapPlan, header, state.mapping.plan || guessColumn(header, CAND_PLAN));
    });

    function fillSelect(sel, items, selected) {
      sel.innerHTML = '';
      for (const it of items) {
        const opt = document.createElement('option');
        opt.value = it; opt.textContent = it;
        if (it === selected) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    btnSaveMapping.addEventListener('click', () => {
      state.mapping = { wsid: mapWSID.value, lokasi: mapLokasi.value, plan: mapPlan.value };
      saveJSON(LS_KEYS.columnMap, state.mapping);
      alert('Mapping tersimpan.');
    });

    // ----------------------- PROSES DATA (konversi & sorting) -----------------------
    btnProcess.addEventListener('click', () => {
      if (!state.rawRows.length) { alert('Belum ada data Excel dibaca.'); return; }
      if (!state.mapping.wsid || !state.mapping.lokasi || !state.mapping.plan) {
        alert('Lengkapi mapping WSID, Lokasi, dan Plan.'); return;
      }

      const out = [];
      const A = state._A;
      const headerRowIdx = state._headerRowIdx;
      const cols = Object.keys(state.rawRows[0] || {});
      const planColIdx = cols.indexOf(state.mapping.plan);

      for (let i = 0; i < state.rawRows.length; i++) {
        const r = state.rawRows[i];

        const wsid = String(r[state.mapping.wsid] ?? '').trim();
        const lokasi = String(r[state.mapping.lokasi] ?? '').trim();

        // Ambil nilai Plan raw dan konversi jika memungkinkan
        let planRaw = r[state.mapping.plan];
        let planDate = null;

        // 1) Jika serial Excel
        if (typeof planRaw === 'number') {
          const d = excelSerialToDate(planRaw);
          if (d) { planDate = d; }
        }
        // 2) Jika string, coba parse pola umum
        if (!planDate) {
          const d2 = tryParsePlanText(planRaw);
          if (d2) planDate = d2;
        }

        // Teks tampil: jika ada date → format; jika tidak → jadikan string apa adanya
        const planText = planDate ? fmtDate(planDate, 'id-ID') : String(planRaw ?? '').trim();

        if (!wsid) continue;
        const key = `${wsid}|${planText}`;
        const status = state.statusByKey[key] || 'outstanding'; // default

        out.push({
          WSID: wsid,
          Lokasi: lokasi,
          Plan: planText,
          Status: status,
          PlanAt: planDate ? planDate.getTime() : Number.POSITIVE_INFINITY // kunci sorting (yang tidak ada tanggal → taruh bawah)
        });
      }

      // Simpan dataset
      state.dataset = out;
      saveJSON(LS_KEYS.lastDataset, state.dataset);

      // Rekonsiliasi order untuk tab "mine"
      state.wsidOrder = (loadJSON(LS_KEYS.wsidOrder) || state.userWsids.slice());
      state.wsidOrder = state.wsidOrder.filter(w => state.userWsids.includes(w));
      for (const w of state.userWsids) if (!state.wsidOrder.includes(w)) state.wsidOrder.push(w);
      saveJSON(LS_KEYS.wsidOrder, state.wsidOrder);

      renderHead(); renderTable();
      alert(`Proses selesai. Baris valid: ${out.length}`);
    });

    // Restore dataset jika ada
    const persisted = loadJSON(LS_KEYS.lastDataset);
    if (persisted && Array.isArray(persisted)) { state.dataset = persisted; }
    renderHead(); renderTable();

    // ----------------------- Render Head, Colgroup & Table -----------------------
    function buildColsConfig() {
      if (state.activeTab === 'mine') {
        return [
          { key: '__handle', width: 'var(--w-handle)' },
          { key: 'WSID', width: 'var(--w-wsid)' },
          { key: 'Lokasi', width: 'var(--w-lokasi)', cls: 'cell-left' },
          { key: 'Plan', width: 'var(--w-plan)' },
          { key: 'Status', width: 'var(--w-status)' },
          { key: 'Note', width: 'var(--w-note)' },
        ];
      } else {
        return [
          { key: 'WSID', width: 'var(--w-wsid)' },
          { key: 'Lokasi', width: 'var(--w-lokasi)', cls: 'cell-left' },
          { key: 'Plan', width: 'var(--w-plan)' },
          { key: 'Status', width: 'var(--w-status)' },
        ];
      }
    }

    function renderHead() {
      const cols = buildColsConfig();
      // colgroup (agar header & body sejajar)
      colgroup.innerHTML = '';
      for (const c of cols) { const col = document.createElement('col'); col.style.width = c.width; colgroup.appendChild(col); }

      // thead
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      for (const c of cols) {
        if (c.key === '__handle') { const th = document.createElement('th'); th.innerHTML = ''; tr.appendChild(th); continue; }
        const th = document.createElement('th');
        th.textContent = c.key;
        if (c.cls) th.className = c.cls;
        tr.appendChild(th);
      }
      thead.appendChild(tr);
    }

    function renderTable() {
      tbody.innerHTML = '';

      // 1) Filter WSID Saya
      const mineData = filterByMyWsids(state.dataset);

      // 2) Sort by PlanAt (termuda → tertua). Infinity (non-date) akan ada di bawah.
      mineData.sort((a, b) => (a.PlanAt || Infinity) - (b.PlanAt || Infinity));

      // 3) Filter status (All/Done/Outstanding)
      const shown = applyStatusFilter(mineData);

      // metrics
      const total = shown.length, done = shown.filter(r => r.Status === 'done').length, out = shown.filter(r => r.Status === 'outstanding').length;
      mTotal.textContent = total; mDone.textContent = done; mOut.textContent = out;

      for (const row of shown) {
        const tr = document.createElement('tr');

        if (state.activeTab === 'mine') {
          const tdH = document.createElement('td'); tdH.innerHTML = '<span class="handle" title="Tahan lalu geser">⋮⋮</span>';
          attachDragHandlers(tr, row.WSID); tr.appendChild(tdH);
        }

        tr.appendChild(cell(row.WSID, 'compact'));
        tr.appendChild(cell(row.Lokasi, 'cell-left'));
        tr.appendChild(cell(row.Plan, 'compact'));

        // Status select (berwarna)
        const tdStatus = document.createElement('td');
        const sel = document.createElement('select');
        sel.className = 'status-select';
        sel.innerHTML = '<option value="outstanding">outstanding</option><option value="done">done</option>';
        sel.value = row.Status || 'outstanding';
        colorizeStatusSelect(sel);
        sel.addEventListener('change', () => {
          const key = keyOf(row);
          row.Status = sel.value; // update in-memory
          state.statusByKey[key] = sel.value;
          saveJSON(LS_KEYS.statusByKey, state.statusByKey);
          colorizeStatusSelect(sel);
          // refresh metrics only:
          const filtered = applyStatusFilter(filterByMyWsids(state.dataset).sort((a, b) => (a.PlanAt || Infinity) - (b.PlanAt || Infinity)));
          mTotal.textContent = filtered.length;
          mDone.textContent = filtered.filter(r => r.Status === 'done').length;
          mOut.textContent = filtered.filter(r => r.Status === 'outstanding').length;
        });
        tdStatus.appendChild(sel);
        tr.appendChild(tdStatus);

        if (state.activeTab === 'mine') {
          const key = keyOf(row);
          const td = document.createElement('td');
          const ta = document.createElement('textarea');
          ta.value = state.notesByKey[key] || '';
          ta.placeholder = 'Catatan mesin ini...';
          let t = null; ta.addEventListener('input', () => { clearTimeout(t); t = setTimeout(() => { state.notesByKey[key] = ta.value; saveJSON(LS_KEYS.notesByKey, state.notesByKey); }, 700); });
          td.appendChild(ta); tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }
    }

    function colorizeStatusSelect(sel) {
      sel.classList.remove('status-done', 'status-outstanding');
      if (sel.value === 'done') sel.classList.add('status-done');
      else sel.classList.add('status-outstanding');
    }

    function cell(text, extraCls = '') { const td = document.createElement('td'); td.className = extraCls; td.textContent = text ?? ''; return td; }
    function applyStatusFilter(arr) { if (state.filter === 'all') return arr; return arr.filter(r => r.Status === state.filter); }
    function filterByMyWsids(arr) {
      const mine = new Set(state.userWsids);
      const arrMine = arr.filter(r => mine.has(r.WSID));
      if (state.activeTab === 'excel') return arrMine; // tidak urut custom WSID
      // tab "mine": urut sesuai wsidOrder, tapi tetap disort PlanAt di dalam masing-masing WSID
      const group = new Map();
      for (const r of arrMine) { if (!group.has(r.WSID)) group.set(r.WSID, []); group.get(r.WSID).push(r); }
      for (const [w, rows] of group) { rows.sort((a, b) => (a.PlanAt || Infinity) - (b.PlanAt || Infinity)); }
      const out = [];
      for (const w of state.wsidOrder) { const rows = group.get(w); if (rows) out.push(...rows); }
      for (const [w, rows] of group) { if (!state.wsidOrder.includes(w)) out.push(...rows); }
      return out;
    }

    // ----------------------- Drag & Drop (long-press) di tab "mine" -----------------------
    let drag = { active: false, wsid: null, startY: 0, startX: 0, pressT: null, ghost: null };
    function attachDragHandlers(tr, wsid) {
      function onDown(e) {
        if (state.activeTab !== 'mine') return;
        drag.wsid = wsid;
        drag.startY = (e.touches ? e.touches[0].clientY : e.clientY);
        drag.startX = (e.touches ? e.touches[0].clientX : e.clientX);
        drag.pressT = setTimeout(() => beginDrag(tr), 350);
        document.addEventListener('mouseup', onUp, { once: true });
        document.addEventListener('touchend', onUp, { once: true });
        document.addEventListener('mousemove', onMove);
        document.addEventListener('touchmove', onMove, { passive: false });
      }
      function onMove(e) {
        if (!drag.pressT && !drag.active) return;
        const cx = (e.touches ? e.touches[0].clientX : e.clientX);
        const cy = (e.touches ? e.touches[0].clientY : e.clientY);
        const dx = Math.abs(cx - drag.startX), dy = Math.abs(cy - drag.startY);
        if (drag.pressT && (dx > 8 || dy > 8)) { clearTimeout(drag.pressT); drag.pressT = null; }
        if (drag.active) {
          e.preventDefault();
          drag.ghost.style.transform = `translateY(${cy - drag.startY}px)`;
          const rows = Array.from(tbody.querySelectorAll('tr'));
          let targetIndex = 0;
          for (let i = 0; i < rows.length; i++) { const r = rows[i]; const rect = r.getBoundingClientRect(); if (cy > rect.top + rect.height / 2) targetIndex = i + 1; }
          tbody.querySelectorAll('.placeholder').forEach(el => el.remove());
          const ph = document.createElement('div'); ph.className = 'placeholder';
          if (targetIndex >= rows.length) { rows[rows.length - 1]?.after(ph); } else { rows[targetIndex]?.before(ph); }
        }
      }
      function onUp() {
        clearTimeout(drag.pressT); drag.pressT = null;
        if (drag.active) {
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const orderedWsids = [];
          for (const r of rows) {
            // pada tab "mine", kolom 1 (setelah handle) = WSID
            const td = r.children[1];
            const w = td?.textContent.trim(); if (w) orderedWsids.push(w);
          }
          const seen = new Set(), uniq = []; for (const w of orderedWsids) { if (!seen.has(w)) { seen.add(w); uniq.push(w); } }
          state.wsidOrder = uniq; saveJSON(LS_KEYS.wsidOrder, state.wsidOrder);
          tbody.querySelectorAll('.placeholder').forEach(el => el.remove());
          drag.ghost?.remove(); drag.active = false; drag.wsid = null;
          renderTable();
        }
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('touchmove', onMove);
      }
      function beginDrag(trEl) {
        drag.active = true; trEl.classList.add('dragging');
        const rect = trEl.getBoundingClientRect();
        const g = document.createElement('div');
        g.style.position = 'fixed'; g.style.left = rect.left + 'px'; g.style.top = rect.top + 'px';
        g.style.width = rect.width + 'px'; g.style.height = rect.height + 'px';
        g.style.pointerEvents = 'none'; g.style.background = 'rgba(0,0,0,.15)';
        g.style.backdropFilter = 'blur(1px)'; g.style.border = '1px dashed var(--c-accent)'; g.style.borderRadius = '8px';
        document.body.appendChild(g); drag.ghost = g;
      }
      tr.addEventListener('mousedown', onDown);
      tr.addEventListener('touchstart', onDown, { passive: true });
    }

    // ----------------------- Export/Import Config & CSV -----------------------
    btnExportConfig.addEventListener('click', () => {
      const cfg = {
        userWsids: state.userWsids,
        columnMapping: state.mapping,
        wsidOrder: state.wsidOrder,
        notesByKey: state.notesByKey,
        statusByKey: state.statusByKey
      };
      downloadJSON(cfg, 'wsid-config.json');
    });
    importConfig.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const text = await f.text();
      try {
        const cfg = JSON.parse(text);
        if (cfg.userWsids) { state.userWsids = [...new Set(cfg.userWsids)]; saveJSON(LS_KEYS.userWsids, state.userWsids); taWsids.value = state.userWsids.join('\n'); updateWsidsCount(); }
        if (cfg.columnMapping) { state.mapping = cfg.columnMapping; saveJSON(LS_KEYS.columnMap, state.mapping); }
        if (cfg.wsidOrder) { state.wsidOrder = cfg.wsidOrder; saveJSON(LS_KEYS.wsidOrder, state.wsidOrder); }
        if (cfg.notesByKey) { state.notesByKey = cfg.notesByKey; saveJSON(LS_KEYS.notesByKey, state.notesByKey); }
        if (cfg.statusByKey) { state.statusByKey = cfg.statusByKey; saveJSON(LS_KEYS.statusByKey, state.statusByKey); }
        renderHead(); renderTable();
        alert('Import konfigurasi selesai.');
      } catch (err) { alert('File konfigurasi tidak valid.'); }
      e.target.value = '';
    });

    btnExportCSV.addEventListener('click', () => {
      const data = applyStatusFilter(filterByMyWsids(state.dataset).sort((a, b) => (a.PlanAt || Infinity) - (b.PlanAt || Infinity)));
      const withNote = data.map(r => {
        const k = keyOf(r); return { ...r, Note: state.notesByKey[k] || '' };
      });
      const csv = toCSV(withNote);
      downloadBlob(new Blob([csv], { type: 'text/csv;charset=utf-8' }), `wsid-${state.activeTab}.csv`);
    });

    function toCSV(rows) {
      if (!rows.length) return '';
      const cols = Object.keys(rows[0]);
      const esc = s => `"${String(s ?? '').replace(/"/g, '""')}"`;
      const head = cols.map(esc).join(',');
      const body = rows.map(r => cols.map(c => esc(r[c])).join(',')).join('\n');
      return head + '\n' + body;
    }
    function downloadJSON(obj, name) { downloadBlob(new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' }), name); }
    function downloadBlob(blob, name) { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(a.href), 500); }
  </script>
</body>

</html>